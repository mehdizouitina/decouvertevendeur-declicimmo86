<!DOCTYPE html>
<html lang="fr">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiche DÃ©couverte Vendeur â€“ DÃ©clic Immo</title>

<!-- FONT â€“ Apple style -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* ======= TA CSS ICI â€“ inchangÃ©e ======= */
</style>
</head>

<body>

<!-- ======== TOP BAR ======== -->
<header class="topbar">
    <div class="topbar-left">
        <span class="topbar-title">Fiche DÃ©couverte Vendeur</span>
    </div>

    <div class="topbar-actions">
        <button id="modeToggle" class="top-btn">ğŸŒ™ Mode sombre</button>
        <button id="newFicheBtn" class="top-btn">Nouvelle fiche</button>
        <button id="openHistoryBtn" class="top-btn">ğŸ“ Historique</button>
        <button id="saveBtn" class="top-btn primary">ğŸ’¾ Sauvegarder</button>
        <button id="pdfBtn" class="top-btn danger">ğŸ“„ PDF</button>
    </div>
</header>

<div id="saveStatus" style="padding:12px 22px; font-size:0.9rem; opacity:0.7;">
    DerniÃ¨re sauvegarde : jamais
</div>

<!-- ===== PANEL HISTORIQUE ===== -->
<div id="historyPanel" class="history-panel">
    <h2 style="margin-bottom:15px;">Fiches sauvegardÃ©es</h2>
    <input type="text" id="historySearch" placeholder="Rechercher..." style="width:100%; padding:10px; border-radius:10px; margin-bottom:20px;">
    <div id="historyList"></div>
    <button id="closeHistoryBtn" class="top-btn" style="margin-top:20px;">Fermer</button>
</div>

<div id="historyOverlay" class="history-overlay"></div>

<!-- ======== CONTENU PRINCIPAL ======== -->
<div class="container">

<!-- ===== SECTIONS (inchangÃ©es) ===== -->
<!-- Je garde tout le HTML identique â€” aucun problÃ¨me dans ces sections -->

</div> <!-- FIN CONTAINER -->

<!-- ======================
     JS PRINCIPAL â€“ FIXED
======================= -->
<script>

/* =========================================================
   CONSTANTES
========================================================= */
const STORAGE_KEY = "declic_fiches_index";
const FICHE_PREFIX = "fiche_";
let currentFicheId = null;
let autoSaveInterval = null;

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
    chargerDerniereFiche();
    activerActionsTopbar();
    activerHistorique();
    activerModeSombre();
    initialiserTableauPieces();
    lancerAutoSave();
});

/* =========================================================
   CREATION / REINITIALISATION
========================================================= */

function nouvelleFiche() {
    if (!confirm("CrÃ©er une nouvelle fiche ? Toutes les donnÃ©es non sauvegardÃ©es seront perdues.")) return;
    currentFicheId = genererIdFiche();
    viderFormulaire();
    viderPieces();
    mettreAJourIndex();
    afficherToast("Nouvelle fiche crÃ©Ã©e");
}

function chargerDerniereFiche() {
    const index = chargerIndex();
    if (index.length === 0) {
        currentFicheId = genererIdFiche();
        sauvegarderFiche();
        return;
    }
    const derniere = index[index.length - 1];
    currentFicheId = derniere.id;
    chargerFiche(currentFicheId);
}

function genererIdFiche() {
    return FICHE_PREFIX + Date.now();
}

function viderFormulaire() {
    document.querySelectorAll("input, textarea, select").forEach(el => {
        if (el.type === "checkbox") el.checked = false;
        else el.value = "";
    });
}

function viderPieces() {
    document.getElementById("piecesTbody").innerHTML = "";
    document.getElementById("surfaceTotale").textContent = "0";
}

/* =========================================================
   SAUVEGARDE
========================================================= */

function sauvegarderFiche() {
    if (!currentFicheId) currentFicheId = genererIdFiche();
    const data = collecterDonnees();
    localStorage.setItem(currentFicheId, JSON.stringify(data));
    mettreAJourIndex(data);
    majIndicateurSauvegarde();
}

function lancerAutoSave() {
    autoSaveInterval = setInterval(() => sauvegarderFiche(), 8000);
}

function majIndicateurSauvegarde() {
    document.getElementById("saveStatus").textContent =
        "DerniÃ¨re sauvegarde : " + new Date().toLocaleTimeString("fr-FR");
}

/* =========================================================
   CHARGEMENT
========================================================= */

function chargerFiche(id) {
    const raw = localStorage.getItem(id);
    if (!raw) return;

    const data = JSON.parse(raw);

    Object.keys(data.form).forEach(key => {
        const el = document.getElementById(key);
        if (!el) return;
        if (el.type === "checkbox") el.checked = data.form[key];
        else el.value = data.form[key];
    });

    viderPieces();
    data.pieces.forEach(p => ajouterLignePiece(p));

    currentFicheId = id;
    recalculerSurfaceTotale();
    afficherToast("Fiche chargÃ©e");
}

